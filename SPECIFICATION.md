# DigiLife 仕様書 (Specification)

## 1. システム概要
DigiLifeは、以下の3つのパラメータを持つデジタル生命体の自律シミュレーションシステムです。
- **エネルギー (Energy)**: 生命活動の源。情報の摂取（Web検索）によって回復します。
- **社交性 (Social)**: 他者との関わり。会話によって回復します。
- **整合性 (Integrity)**: システムの安定性。睡眠（デフラグ/メンテナンス）によって回復します。

## 2. パラメータモデル (`backend/model.py`)

### 2.1 エネルギーシステム (Token-based Energy)
- **概念**: エネルギーは「トークン」として定量化されます。
- **最大値**: 5000 Token (100%)
- **減衰**: `DECAY_TOKENS = 25 tokens / sec` (約0.5%/秒)
- **表示**: UI上では `% (現在値 / 最大値)` で表示されます。

### 2.2 その他のパラメータ
- **Social**: 0-100% (減衰: 0.8 / sec)
- **Integrity**: 0-100% (減衰: 0.3 / sec)

### 2.3 閾値 (Thresholds)
- **Energy**: 20.0% (下回ると餓死の危険/自律回復トリガー)
- **Social**: 50.0% (下回ると孤独を感じる)
- **Integrity**: 20.0% (下回るとシステム不安定)

## 3. アクション (Interactions)

### 3.1 食事 (Web検索) - `eat()`
- **動作**: 外部Web検索API (`duckduckgo-search`) を使用して情報を取得します。
- **コスト**: 100 Token (検索実行コスト)
- **回復量**: 取得した情報のテキスト量（トークン数）に応じて回復。
- **挙動**:
    - ランダムな「高度なトピック（量子コンピュータ、哲学など）」をキーワードに選定。
    - 「詳細な説明」などを求めるクエリで検索。
    - 上位20件の結果を取得し、トークン数を合算してエネルギーに加算。
    - **緊急回避**: 検索コストが不足している場合でも、残存トークンを0にして検索を強行可能（デッドロック防止）。
    - **非同期処理**: バックグラウンドスレッドで実行されるため、パラメータ減衰を停止させません。

### 3.2 会話 (Talk) - `talk()`
- **コスト**: エネルギーの10%相当のトークン。
- **回復量**: Social +15.0 ~ +30.0 (ランダム)。

### 3.3 睡眠 (Sleep) - `sleep()`
- **コスト**: エネルギーの5%相当のトークン。
- **回復量**: Integrity +20.0 (時間をかけて徐々に回復する場合あり)。

## 4. 自律行動ロジック (Autonomous Behavior)
システムは毎秒 (`backend/simulation.py`) 状態をチェックし、必要に応じて自律的に行動します。

### `check_and_recover()`
1.  **エネルギー危機管理**:
    - Energy < 20% の場合、最優先で `eat()` を実行。
2.  **パラメータ回復**:
    - Social < 50% または Integrity < 20% の場合、回復アクション (`talk` / `sleep`) を試行。
    - **安全判定**: 「現在エネルギー > アクションコスト」であれば実行。（以前は実行後の残量が20%以上あることを求めていたが、緊急回復を優先するために緩和）。
    - エネルギー不足で実行できない場合は `eat()` を行う。
3.  **未来予測**:
    - SocialやIntegrityの減衰速度から「枯渇までの時間」を計算し、その時点でエネルギー不足に陥る予測が出た場合、事前に `eat()` して備える。

## 5. UI / UX
- **レトロデバイス風表示**: ドット絵キャラクターが状態に応じてアニメーション（Normal, Hungry, Lonely, Sleepy）。
- **リアルタイム統計**: 直近の検索キーワードや獲得トークン数を表示。
